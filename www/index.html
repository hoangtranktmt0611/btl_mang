<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Chat App</title>
<style>
body {
    font-family: Arial, sans-serif;
    margin: 20px;
}

#chat-box {
    background: #f9f9f9;
    padding: 10px;
    overflow-y: auto;
    height: 300px;
}

#peer-list {
    list-style: none;
    padding-left: 0;
}

#peer-list li {
    padding: 4px;
    cursor: pointer;
    border-bottom: 1px solid #eee;
}

#peer-list li:hover {
    background-color: #f0f0f0;
}

input[type="text"] {
    padding: 5px;
}
button {
    padding: 5px 10px;
}
</style>
</head>
<body>
<h1>Chat App</h1>

<div style="display:flex; gap:20px;">

  <!-- Danh sách peer online -->
  <div>
    <h3>Peers online</h3>
    <ul id="peer-list"></ul>
    <button id="refresh-peers">Refresh</button>
  </div>

  <!-- Chat box -->
  <div style="flex-grow:1;">
    <h3>Chat</h3>
    <div id="chat-box"></div>
    <input type="text" id="message" placeholder="Type your message..." style="width:70%;">
    <button id="send-broadcast">Send</button>
  </div>

</div>

<script>
const chatBox = document.getElementById("chat-box");
const messageInput = document.getElementById("message");
const sendBroadcastBtn = document.getElementById("send-broadcast");
const peerListEl = document.getElementById("peer-list");
const refreshPeersBtn = document.getElementById("refresh-peers");

let username = "guest"; // Lấy từ cookie hoặc login
let host = "127.0.0.1"; // client host
let port = 8000;         // client port (tùy config)

function appendMessage(msg) {
    const div = document.createElement("div");
    div.textContent = msg;
    chatBox.appendChild(div);
    chatBox.scrollTop = chatBox.scrollHeight;
}

// --- Gọi /add-list để đăng ký user ---
async function addSelfToList() {
    if (!username) return;
    const body = { user: username, item: "hello", host, port };
    try {
        await fetch("/add-list", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body)
        });
    } catch(e) {
        console.error("Add list failed:", e);
    }
}

// --- Lấy danh sách peer online ---
async function refreshPeers() {
    await addSelfToList(); // đảm bảo mình đã add trước khi fetch list
    const res = await fetch("/get-list");
    if (!res.ok) return;
    const data = await res.json();
    peerListEl.innerHTML = "";
    data.list.forEach(peer => {
        if (peer.user && peer.user !== username) {
            const li = document.createElement("li");
            li.textContent = peer.user;
            li.addEventListener("click", () => {
                const msg = prompt(`Send private message to ${peer.user}:`);
                if (msg) sendPrivate(peer.user, msg);
            });
            peerListEl.appendChild(li);
        }
    });
}

// --- Gửi broadcast ---
async function sendBroadcast() {
    const msg = messageInput.value.trim();
    if (!msg) return;
    const body = { from: username, message: msg };
    const res = await fetch("/broadcast-peer", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify(body)
    });
    appendMessage(`[You] ${msg}`);
    messageInput.value = "";
}

// --- Gửi tin nhắn riêng ---
async function sendPrivate(target, msg) {
    const body = { from: username, to: target, message: msg };
    await fetch("/send-peer", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify(body)
    });
    appendMessage(`[You → ${target}] ${msg}`);
}

// --- Event listeners ---
sendBroadcastBtn.addEventListener("click", sendBroadcast);
refreshPeersBtn.addEventListener("click", refreshPeers);

// --- Load danh sách peer khi mở trang ---
refreshPeers();

// --- Tự động refresh peer mỗi 5 giây ---
setInterval(refreshPeers, 5000);
</script>

</body>
</html>
